<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>投稿作成</title>
</head>
<body>
<div th:fragment="post-write">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/summernote@0.8.18/dist/summernote-lite.min.js"></script>
    <link rel="stylesheet" th:href="@{/css/post.css}">

    <div class="write-container">
        <h2 class="write-header-title"
            th:text="${postForm.postId != null} ? ${boardName} + ' 掲示板投稿修正' : ${boardName} + ' 掲示板投稿作成'">
            新規投稿
        </h2>

        <form th:action="${postForm.postId != null} ? @{/board/{bn}/update/{pid}(bn=${boardName}, pid=${postForm.postId})} : @{/board/{bn}/save(bn=${boardName})}"
              th:object="${postForm}"
              method="post">

            <input type="hidden" th:field="*{postId}">

            <div class="write-section">
                <input type="text" th:field="*{title}" class="write-input-title" placeholder="タイトルを入力してください" required>
            </div>

            <div class="write-section">
                <textarea th:field="*{content}" id="summernote" class="write-textarea-content" required></textarea>
            </div>

            <div class="write-footer">
                <button type="button" class="btn-sub"
                        th:data-url="|/board/${boardName}/list|"
                        onclick="location.href=this.getAttribute('data-url')">キャンセル</button>
                <button type="submit" class="btn-main" th:text="${postForm.postId != null} ? '修正' : '投稿'">投稿</button>
            </div>
        </form>
    </div>

    <script th:inline="javascript">
        $(document).ready(function() {
            $('#summernote').summernote({
                height: 500,
                focus: true,
                lang: "ja-JP",
                placeholder: '内容を入力してください。',
                toolbar: [
                    ['style', ['style']],
                    ['font', ['bold', 'underline', 'clear']],
                    ['color', ['color']],
                    ['para', ['ul', 'ol', 'paragraph']],
                    ['table', ['table']],
                    ['insert', ['link', 'picture', 'video']],
                    ['view', ['fullscreen', 'codeview', 'help']]
                ],
                callbacks: {
                    onImageUpload: function(files) {
                        for (let i = 0; i < files.length; i++) {
                            uploadImage(files[i], this);
                        }
                    }
                }
            });
        });

        function uploadImage(file, editor) {
            const formData = new FormData();
            formData.append("file", file);

            $.ajax({
                url: '/api/image/upload',
                method: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function(url) {
                    // 成功時: サーバーから受け取ったURLで画像挿入
                    $(editor).summernote('insertImage', url);
                },
                error: function() {
                    alert("画像アップロードに失敗しました。");
                }
            });
        }
    </script>
</div>
</body>
</html>
